---
  - name:                  Enable cgroup params added in /boot/firmware/cmdline.txt
    become_method:         sudo
    become:                true
    block:
    - ansible.builtin.lineinfile:
        path:              ~/boot_firmware_cmdline.txt
        #path:             /boot/firmware/cmdline.txt
        insertbefore:      BOF
        line:              cgroup_enable=cpuset cgroup_enable=memory cgroup_memory=1
        create:            yes
    - name:                echo reboot
      shell:               /usr/bin/echo 'reboot'
      register:            must_reboot
  - name:                  Display cmdline.txt after editing
    #shell:                cat /boot/firmware/cmdline.txt
    shell:                 cat ~/boot_firmware_cmdline.txt
    args:
      executable:          /bin/bash
    register:              cmdlineposttxt_status
  - debug:                 var=cmdlineposttxt_status.stdout_lines

  - name:                  Reboot immediately if there was a change.
    become_method:         sudo
    become:                true
    block:
    - shell:               "sleep 5 && shutdown -r now"
      async:               300
      poll:                0
      ignore_errors:       true
      when:                must_reboot is changed

    - name:                Wait for the reboot to complete if there was a change.
      wait_for_connection:
  #      connect_timeout:  20
  #      sleep:            5
        delay:             60
        timeout:           300
      when:                '"reboot" in must_reboot.stdout'

#    - name:               re-mount the shared folder after a Reboot
#      mount:
#        path:             /mnt
#        src:              mnt
#        fstype:           vboxsf
#        state:            mounted
